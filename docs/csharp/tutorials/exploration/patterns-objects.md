---
title: オブジェクトでパターンを使用する - C# チュートリアル
description: このチュートリアルでは、クラス メンバーでパターン マッチングを使用して、オブジェクトの動作により適したモデルを作成する方法について説明します
ms.date: 11/05/2020
ms.openlocfilehash: 072f6f57696504c2d691473e3a43c1cda53f227f
ms.sourcegitcommit: 6bef8abde346c59771a35f4f76bf037ff61c5ba3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/06/2020
ms.locfileid: "94332175"
---
# <a name="use-pattern-matching-to-build-your-class-behavior-for-better-code"></a><span data-ttu-id="0af1e-103">パターン マッチングを使用して、より良いコードのためのクラスの動作を構築する</span><span class="sxs-lookup"><span data-stu-id="0af1e-103">Use pattern matching to build your class behavior for better code</span></span>

<span data-ttu-id="0af1e-104">C# のパターン マッチング機能には、アルゴリズムを表すための構文が用意されています。</span><span class="sxs-lookup"><span data-stu-id="0af1e-104">The pattern matching features in C# provide syntax to express your algorithms.</span></span> <span data-ttu-id="0af1e-105">これらの手法を使用して、クラスの動作を実装できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-105">You can use these techniques to implement the behavior in your classes.</span></span> <span data-ttu-id="0af1e-106">オブジェクト指向のクラス設計と、データ指向の実装を組み合わせることで、現実のオブジェクトをモデル化しながら、簡潔なコードを提供できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-106">You can combine object-oriented class design with a data-oriented implementation to provide concise code while modeling real-world objects.</span></span>

<span data-ttu-id="0af1e-107">このチュートリアルで学習する内容は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="0af1e-107">In this tutorial, you'll learn how to:</span></span>

> [!div class="checklist"]
>
> - <span data-ttu-id="0af1e-108">データ パターンを使用して、オブジェクト指向のクラスを表現します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-108">Express your object oriented classes using data patterns.</span></span>
> - <span data-ttu-id="0af1e-109">C# のパターン マッチング機能を使用して、それらのパターンを実装します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-109">Implement those patterns using C#'s pattern matching features.</span></span>
> - <span data-ttu-id="0af1e-110">コンパイラの診断機能を利用して、実装を検証します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-110">Leverage compiler diagnostics to validate your implementation.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="0af1e-111">前提条件</span><span class="sxs-lookup"><span data-stu-id="0af1e-111">Prerequisites</span></span>

<span data-ttu-id="0af1e-112">コンピューターを、C# 9.0 コンパイラが含まれる .NET 5 が実行されるように設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-112">You’ll need to set up your machine to run .NET 5, including the C# 9.0 compiler.</span></span> <span data-ttu-id="0af1e-113">C# 9.0 コンパイラは、[Visual Studio 2019 バージョン 16.8 プレビュー](https://visualstudio.microsoft.com/vs/preview/)以降または [.NET 5.0 SDK プレビュー](https://dotnet.microsoft.com/download/dotnet/5.0)以降で使用できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-113">The C# 9.0 compiler is available starting with [Visual Studio 2019 version 16.8 preview](https://visualstudio.microsoft.com/vs/preview/) or the [.NET 5.0 SDK preview](https://dotnet.microsoft.com/download/dotnet/5.0).</span></span>

## <a name="build-a-simulation-of-a-canal-lock"></a><span data-ttu-id="0af1e-114">運河の水門のシミュレーションを構築する</span><span class="sxs-lookup"><span data-stu-id="0af1e-114">Build a simulation of a canal lock</span></span>

<span data-ttu-id="0af1e-115">このチュートリアルでは、[運河の水門](https://en.wikipedia.org/wiki/Lock_(water_navigation))をシミュレートする C# クラスを構築します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-115">In this tutorial, you'll build a C# class that simulates a [canal lock](https://en.wikipedia.org/wiki/Lock_(water_navigation)).</span></span> <span data-ttu-id="0af1e-116">簡単に言うと、運河の水門は、水面の高さが異なる 2 つの水路の間を通過するときに船を上げ下げする仕組みです。</span><span class="sxs-lookup"><span data-stu-id="0af1e-116">Briefly, a canal lock is a device that raises and lowers boats as they travel between two stretches of water at different levels.</span></span> <span data-ttu-id="0af1e-117">水門には、2 つのゲートと、水位を変更するためのメカニズムがあります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-117">A lock has two gates and some mechanism to change the water level.</span></span>

<span data-ttu-id="0af1e-118">通常の操作では、船が一方のゲートから進入するとき、水門の水位は船が進入する側の水位と一致しています。</span><span class="sxs-lookup"><span data-stu-id="0af1e-118">In its normal operation, a boat enters one of the gates while the water level in the lock matches the water level on the side the boat enters.</span></span> <span data-ttu-id="0af1e-119">水門内に入ると、船が水門から出て行く側の水位と一致するように、水位が変更されます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-119">Once in the lock, the water level is changed to match the water level where the boat will leave the lock.</span></span> <span data-ttu-id="0af1e-120">水位がその側と一致すると、出口側のゲートが開きます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-120">Once the water level matches that side, the gate on the exit side opens.</span></span> <span data-ttu-id="0af1e-121">安全対策により、オペレーターは運河を危険な状態にできないようになっています。</span><span class="sxs-lookup"><span data-stu-id="0af1e-121">Safety measures make sure an operator can't create a dangerous situation in the canal.</span></span> <span data-ttu-id="0af1e-122">水位は、両方のゲートが閉じられている場合にのみ変更できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-122">The water level can be changed only when both gates are closed.</span></span> <span data-ttu-id="0af1e-123">開くことができるのは最大で 1 つのゲートです。</span><span class="sxs-lookup"><span data-stu-id="0af1e-123">At most one gate can be open.</span></span> <span data-ttu-id="0af1e-124">ゲートを開くには、水門内の水位が、開かれるゲートの外側の水位と一致している必要があります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-124">To open a gate, the water level in the lock must match the water level outside the gate being opened.</span></span>

<span data-ttu-id="0af1e-125">この動作をモデル化する C# クラスを構築できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-125">You can build a C# class to model this behavior.</span></span> <span data-ttu-id="0af1e-126">`CanalLock` クラスにより、いずれかのゲートを開いたり閉じたりするコマンドがサポートされます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-126">A `CanalLock` class would support commands to open or close either gate.</span></span> <span data-ttu-id="0af1e-127">他に、水を上げ下げするためのコマンドがあります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-127">It would have other commands to raise or lower the water.</span></span> <span data-ttu-id="0af1e-128">また、このクラスにより、両方のゲートと水位の現在の状態を読み取るためのプロパティもサポートされる必要があります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-128">The class should also support properties to read the current state of both gates and the water level.</span></span> <span data-ttu-id="0af1e-129">これらのメソッドにより安全対策を実装します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-129">Your methods implement the safety measures.</span></span>

## <a name="define-a-class"></a><span data-ttu-id="0af1e-130">クラスを定義する</span><span class="sxs-lookup"><span data-stu-id="0af1e-130">Define a class</span></span>

<span data-ttu-id="0af1e-131">`CanalLock` クラスをテストするコンソール アプリケーションを作成します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-131">You'll build a console application to test your `CanalLock` class.</span></span> <span data-ttu-id="0af1e-132">Visual Studio または .NET CLI を使用して、.NET 5 用の新しいコンソール プロジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-132">Create a new console project for .NET 5 using either Visual Studio or the .NET CLI.</span></span> <span data-ttu-id="0af1e-133">次に、新しいクラスを追加し、`CanalLock` という名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-133">Then, add a new class and name it `CanalLock`.</span></span> <span data-ttu-id="0af1e-134">次に、パブリック API を設計しますが、メソッドは実装しないでおきます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-134">Next, design your public API, but leave the methods not implemented:</span></span>

:::code language="csharp" source="snippets/pattern-objects/InterimSteps.cs" ID="APIDesign":::

<span data-ttu-id="0af1e-135">上のコードにより、両方のゲートが閉じていて、水位が低になるように、オブジェクトが初期化されます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-135">The preceding code initializes the object so both gates are closed, and the water level is low.</span></span> <span data-ttu-id="0af1e-136">次に、クラスの最初の実装を作成するときのガイドにするため、`Main` メソッドに次のテスト コードを記述します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-136">Next, write the following test code in your `Main` method to guide you as you create a first implementation of the class:</span></span>

:::code language="csharp" source="snippets/pattern-objects/Program.cs" ID="HappyTests":::

<span data-ttu-id="0af1e-137">次に、`CanalLock` クラスの各メソッドの最初の実装を追加します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-137">Next, add a first implementation of each method in the `CanalLock` class.</span></span> <span data-ttu-id="0af1e-138">次のコードにより、安全ルールが考慮されていないクラスのメソッドが実装されます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-138">The following code implements the methods of the class without concern to the safety rules.</span></span> <span data-ttu-id="0af1e-139">安全テストは後で追加します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-139">You'll add safety tests later:</span></span>

:::code language="csharp" source="snippets/pattern-objects/InterimSteps.cs" ID="FirstImplementation":::

<span data-ttu-id="0af1e-140">これまでに記述したテストは合格です。</span><span class="sxs-lookup"><span data-stu-id="0af1e-140">The tests you've written so far pass.</span></span> <span data-ttu-id="0af1e-141">基本が実装されました。</span><span class="sxs-lookup"><span data-stu-id="0af1e-141">You've implemented the basics.</span></span> <span data-ttu-id="0af1e-142">次に、最初のエラー条件のテストを記述します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-142">Now, write a test for the first failure condition.</span></span> <span data-ttu-id="0af1e-143">前のテストの終了時点では、両方のゲートは閉じられ、水位は低に設定されています。</span><span class="sxs-lookup"><span data-stu-id="0af1e-143">At the end of the previous tests, both gates are closed, and the water level is set to low.</span></span> <span data-ttu-id="0af1e-144">上の側のゲートを開こうとするテストを追加します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-144">Add a test to try opening the upper gate:</span></span>

:::code language="csharp" source="snippets/pattern-objects/Program.cs" ID="HighGateSafetyTest":::

<span data-ttu-id="0af1e-145">ゲートが開くため、このテストは失敗します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-145">This test fails because the gate opens.</span></span> <span data-ttu-id="0af1e-146">最初の実装として、次のコードを使用して修正できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-146">As a first implementation, you could fix it with the following code:</span></span>

:::code language="csharp" source="snippets/pattern-objects/InterimSteps.cs" ID="SecondImplementation":::

<span data-ttu-id="0af1e-147">テストは合格します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-147">Your tests pass.</span></span> <span data-ttu-id="0af1e-148">しかし、さらにテストを追加していくと、`if` 句がどんどん増え、異なるプロパティをテストするようになります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-148">But, as you add more tests, you'll add more and more `if` clauses and test different properties.</span></span> <span data-ttu-id="0af1e-149">やがて、メソッドが複雑すぎて、条件を追加できなくなります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-149">Soon, these methods will get too complicated as you add more conditionals.</span></span>

## <a name="implement-the-commands-with-patterns"></a><span data-ttu-id="0af1e-150">パターンを使用してコマンドを実装する</span><span class="sxs-lookup"><span data-stu-id="0af1e-150">Implement the commands with patterns</span></span>

<span data-ttu-id="0af1e-151">もっとよい方法は、" *パターン* " を使用して、オブジェクトがコマンドを実行するための有効な状態であるかどうかを判断することです。</span><span class="sxs-lookup"><span data-stu-id="0af1e-151">A better way is to use *patterns* to determine if the object is in a valid state to execute a command.</span></span> <span data-ttu-id="0af1e-152">次の 3 つの変数の関数として、コマンドが許可されるかどうかを表すことができます: ゲートの状態、水位、新しい設定。</span><span class="sxs-lookup"><span data-stu-id="0af1e-152">You can express if a command is allowed as a function of three variables: the state of the gate, the level of the water, and the new setting:</span></span>

| <span data-ttu-id="0af1e-153">新しい設定</span><span class="sxs-lookup"><span data-stu-id="0af1e-153">New setting</span></span> | <span data-ttu-id="0af1e-154">ゲートの状態</span><span class="sxs-lookup"><span data-stu-id="0af1e-154">Gate state</span></span> | <span data-ttu-id="0af1e-155">水位</span><span class="sxs-lookup"><span data-stu-id="0af1e-155">Water Level</span></span> | <span data-ttu-id="0af1e-156">結果</span><span class="sxs-lookup"><span data-stu-id="0af1e-156">Result</span></span>             |
| ----------- | ---------- | ----------- | ------------------ |
| <span data-ttu-id="0af1e-157">［不可］</span><span class="sxs-lookup"><span data-stu-id="0af1e-157">Closed</span></span>      | <span data-ttu-id="0af1e-158">［不可］</span><span class="sxs-lookup"><span data-stu-id="0af1e-158">Closed</span></span>     | <span data-ttu-id="0af1e-159">高</span><span class="sxs-lookup"><span data-stu-id="0af1e-159">High</span></span>        | <span data-ttu-id="0af1e-160">［不可］</span><span class="sxs-lookup"><span data-stu-id="0af1e-160">Closed</span></span>             |
| <span data-ttu-id="0af1e-161">［不可］</span><span class="sxs-lookup"><span data-stu-id="0af1e-161">Closed</span></span>      | <span data-ttu-id="0af1e-162">［不可］</span><span class="sxs-lookup"><span data-stu-id="0af1e-162">Closed</span></span>     | <span data-ttu-id="0af1e-163">低</span><span class="sxs-lookup"><span data-stu-id="0af1e-163">Low</span></span>         | <span data-ttu-id="0af1e-164">［不可］</span><span class="sxs-lookup"><span data-stu-id="0af1e-164">Closed</span></span>             |
| <span data-ttu-id="0af1e-165">［不可］</span><span class="sxs-lookup"><span data-stu-id="0af1e-165">Closed</span></span>      | <span data-ttu-id="0af1e-166">開く</span><span class="sxs-lookup"><span data-stu-id="0af1e-166">Open</span></span>       | <span data-ttu-id="0af1e-167">高</span><span class="sxs-lookup"><span data-stu-id="0af1e-167">High</span></span>        | <span data-ttu-id="0af1e-168">開く</span><span class="sxs-lookup"><span data-stu-id="0af1e-168">Open</span></span>               |
| <span data-ttu-id="0af1e-169">~~解決済み~~</span><span class="sxs-lookup"><span data-stu-id="0af1e-169">~~Closed~~</span></span>  | <span data-ttu-id="0af1e-170">~~[ファイル]~~</span><span class="sxs-lookup"><span data-stu-id="0af1e-170">~~Open~~</span></span>   | <span data-ttu-id="0af1e-171">~~低~~</span><span class="sxs-lookup"><span data-stu-id="0af1e-171">~~Low~~</span></span>     | <span data-ttu-id="0af1e-172">~~解決済み~~</span><span class="sxs-lookup"><span data-stu-id="0af1e-172">~~Closed~~</span></span>         |
| <span data-ttu-id="0af1e-173">開く</span><span class="sxs-lookup"><span data-stu-id="0af1e-173">Open</span></span>        | <span data-ttu-id="0af1e-174">解決済み</span><span class="sxs-lookup"><span data-stu-id="0af1e-174">Closed</span></span>     | <span data-ttu-id="0af1e-175">高</span><span class="sxs-lookup"><span data-stu-id="0af1e-175">High</span></span>        | <span data-ttu-id="0af1e-176">開く</span><span class="sxs-lookup"><span data-stu-id="0af1e-176">Open</span></span>               |
| <span data-ttu-id="0af1e-177">開く</span><span class="sxs-lookup"><span data-stu-id="0af1e-177">Open</span></span>        | <span data-ttu-id="0af1e-178">解決済み</span><span class="sxs-lookup"><span data-stu-id="0af1e-178">Closed</span></span>     | <span data-ttu-id="0af1e-179">低</span><span class="sxs-lookup"><span data-stu-id="0af1e-179">Low</span></span>         | <span data-ttu-id="0af1e-180">閉 (エラー)</span><span class="sxs-lookup"><span data-stu-id="0af1e-180">Closed (Error)</span></span>     |
| <span data-ttu-id="0af1e-181">開く</span><span class="sxs-lookup"><span data-stu-id="0af1e-181">Open</span></span>        | <span data-ttu-id="0af1e-182">開く</span><span class="sxs-lookup"><span data-stu-id="0af1e-182">Open</span></span>       | <span data-ttu-id="0af1e-183">高</span><span class="sxs-lookup"><span data-stu-id="0af1e-183">High</span></span>        | <span data-ttu-id="0af1e-184">開く</span><span class="sxs-lookup"><span data-stu-id="0af1e-184">Open</span></span>               |
| <span data-ttu-id="0af1e-185">~~[ファイル]~~</span><span class="sxs-lookup"><span data-stu-id="0af1e-185">~~Open~~</span></span>    | <span data-ttu-id="0af1e-186">~~[ファイル]~~</span><span class="sxs-lookup"><span data-stu-id="0af1e-186">~~Open~~</span></span>   | <span data-ttu-id="0af1e-187">~~低~~</span><span class="sxs-lookup"><span data-stu-id="0af1e-187">~~Low~~</span></span>     | <span data-ttu-id="0af1e-188">~~閉 (エラー)~~</span><span class="sxs-lookup"><span data-stu-id="0af1e-188">~~Closed (Error)~~</span></span> |

<span data-ttu-id="0af1e-189">表の 4 番目と最後の行は無効であるため、テキストを消してあります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-189">The fourth and last rows in the table have strike through text because they're invalid.</span></span> <span data-ttu-id="0af1e-190">ここで追加しようとしているコードを使用して、水位が低いときは、高い水位のゲートが開かれないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-190">The code you're adding now should make sure the high water gate is never opened when the water is low.</span></span>  <span data-ttu-id="0af1e-191">それらの状態は、1 つの switch 式としてコーディングできます (`false` は "閉" を示すことに注意してください)。</span><span class="sxs-lookup"><span data-stu-id="0af1e-191">Those states can be coded as a single switch expression (remember that `false` indicates "Closed"):</span></span>

:::code language="csharp" source="snippets/pattern-objects/InterimSteps.cs" ID="ThirdImplementation":::

<span data-ttu-id="0af1e-192">このバージョンを試してみます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-192">Try this version.</span></span> <span data-ttu-id="0af1e-193">テストは合格し、コードが検証されました。</span><span class="sxs-lookup"><span data-stu-id="0af1e-193">Your tests pass, validating the code.</span></span> <span data-ttu-id="0af1e-194">完全な表には、入力と結果の可能な組み合わせが示されています。</span><span class="sxs-lookup"><span data-stu-id="0af1e-194">The full table shows the possible combinations of inputs and results.</span></span> <span data-ttu-id="0af1e-195">これは、自分や他の開発者が表をすばやく見て、可能なすべての入力が網羅されていることを確認できることを意味します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-195">That means you and other developers can quickly look at the table and see that you've covered all the possible inputs.</span></span> <span data-ttu-id="0af1e-196">さらに簡単にするには、コンパイラも役に立ちます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-196">Even easier, the compiler can help as well.</span></span> <span data-ttu-id="0af1e-197">前のコードを追加した後、コンパイラによって警告が生成されることがあります。 *CS8524* は、switch 式ですべての可能な入力がカバーされていないことを示します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-197">After you add the previous code, you can see that the compiler generates a warning: *CS8524* indicates the switch expression doesn't cover all possible inputs.</span></span> <span data-ttu-id="0af1e-198">その警告が表示される原因は、入力の 1 つが `enum` 型であることです。</span><span class="sxs-lookup"><span data-stu-id="0af1e-198">The reason for that warning is that one of the inputs is an `enum` type.</span></span> <span data-ttu-id="0af1e-199">コンパイラでは、"可能なすべての入力" は、基になる型からのすべての入力 (通常は `int`) と解釈されます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-199">The compiler interprets "all possible inputs" as all inputs from the underlying type, typically an `int`.</span></span> <span data-ttu-id="0af1e-200">この `switch` 式の場合、`enum` で宣言されている値のみがチェックされています。</span><span class="sxs-lookup"><span data-stu-id="0af1e-200">This `switch` expression only checks the values declared in the `enum`.</span></span> <span data-ttu-id="0af1e-201">警告を除去するには、式の最後のアームに、キャッチオール破棄パターンを追加します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-201">To remove the warning, you can add a catch-all discard pattern for the last arm of the expression.</span></span> <span data-ttu-id="0af1e-202">この状態は無効な入力を示すため、例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="0af1e-202">This condition throws an exception, because it indicates invalid input:</span></span>

```csharp
_  => throw new InvalidOperationException("Invalid internal state"),
```

<span data-ttu-id="0af1e-203">前記の switch アームは、すべての入力に一致するため、`switch` 式の最後に置く必要があります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-203">The preceding switch arm must be last in your `switch` expression because it matches all inputs.</span></span> <span data-ttu-id="0af1e-204">前の方の順序に移動して実験します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-204">Experiment by moving it earlier in the order.</span></span> <span data-ttu-id="0af1e-205">そのようにすると、パターン内に到達できないコードがあることを示すコンパイラ エラー *CS8510* が発生します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-205">That causes a compiler error *CS8510* for unreachable code in a pattern.</span></span>  <span data-ttu-id="0af1e-206">switch 式の自然な構造により、コンパイラはエラーや警告を生成して間違いを防ぐことができます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-206">The natural structure of switch expressions enables the compiler to generate errors and warnings for possible mistakes.</span></span> <span data-ttu-id="0af1e-207">コンパイラの "セーフティ ネット" により、少ない繰り返しで正しいコードをより簡単に作成でき、switch アームとワイルドカードを自由に組み合わせることができます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-207">The compiler "safety net" makes it easier for you to create correct code in fewer iterations, and the freedom to combine switch arms with wildcards.</span></span> <span data-ttu-id="0af1e-208">組み合わせによって意図せず到達できないアームが作成されると、コンパイラによってエラーが表示され、必要なアームを削除すると警告が表示されます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-208">The compiler will issue errors if your combination results in unreachable arms you didn't expect, and warnings if you remove an arm that's needed.</span></span>

<span data-ttu-id="0af1e-209">最初の変更は、コマンドによってゲートが閉じられるすべてのアームを結合することです。これは常に許可されます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-209">The first change is to combine all the arms where the command is to close the gate; that's always allowed.</span></span> <span data-ttu-id="0af1e-210">次のコードを switch 式の最初のアームとして追加します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-210">Add the following code as the first arm in your switch expression:</span></span>

```csharp
(false, _, _) => false,
```

<span data-ttu-id="0af1e-211">前の switch アームを追加すると、4 つのコンパイラ エラーが発生します。コマンドが `false` であるアームごとに 1 つあります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-211">After you add the previous switch arm, you'll get four compiler errors, one on each of the arms where the command is `false`.</span></span> <span data-ttu-id="0af1e-212">それらのアームは、新しく追加したアームによって既にカバーされています。</span><span class="sxs-lookup"><span data-stu-id="0af1e-212">Those arms are already covered by the newly added arm.</span></span> <span data-ttu-id="0af1e-213">それら 4 つの行は安全に削除できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-213">You can safely remove those four lines.</span></span> <span data-ttu-id="0af1e-214">この新しい switch アームを使用して、それらの条件を置き換えます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-214">You intended this new switch arm to replace those conditions.</span></span>

<span data-ttu-id="0af1e-215">次に、ゲートを開くコマンドの 4 つのアームを簡略化できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-215">Next, you can simplify the four arms where the command is to open the gate.</span></span> <span data-ttu-id="0af1e-216">水位が高であるどちらの場合も、ゲートを開くことができます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-216">In both cases where the water level is high, the gate can be opened.</span></span> <span data-ttu-id="0af1e-217">(1 つでは既に開いています)。水位が低である 1 つのケースでは例外がスローされ、もう 1 つのケースでは発生しません。</span><span class="sxs-lookup"><span data-stu-id="0af1e-217">(In one, it's already open.) One case where the water level is low throws an exception, and the other shouldn't happen.</span></span> <span data-ttu-id="0af1e-218">水門が既に無効な状態である場合は、同じ例外がスローされても安全である必要があります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-218">It should be safe to throw the same exception if the water lock is already in an invalid state.</span></span> <span data-ttu-id="0af1e-219">それらのアームは、次のように簡略化できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-219">You can make the following simplifications for those arms:</span></span>

```csharp
(true, _, WaterLevel.High) => true,
(true, false, WaterLevel.Low) => throw new InvalidOperationException("Cannot open high gate when the water is low"),
_ => throw new InvalidOperationException("Invalid internal state"),
```

<span data-ttu-id="0af1e-220">テストを再び実行すると、それらは合格します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-220">Run your tests again, and they pass.</span></span> <span data-ttu-id="0af1e-221">`SetHighGate` メソッドの最終バージョンは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-221">Here's the final version of the `SetHighGate` method:</span></span>

:::code language="csharp" source="snippets/pattern-objects/CanalLock.cs" ID="FinalImplementaton":::

## <a name="implement-patterns-yourself"></a><span data-ttu-id="0af1e-222">パターンを自分で実装する</span><span class="sxs-lookup"><span data-stu-id="0af1e-222">Implement patterns yourself</span></span>

<span data-ttu-id="0af1e-223">これで手法を確認できたので、`SetLowGate` メソッドと `SetWaterLevel` メソッドについては自分で入力してください。</span><span class="sxs-lookup"><span data-stu-id="0af1e-223">Now that you've seen the technique, fill in the `SetLowGate` and `SetWaterLevel` methods yourself.</span></span>  <span data-ttu-id="0af1e-224">まず、次のコードを追加して、それらのメソッドでの無効な操作をテストします。</span><span class="sxs-lookup"><span data-stu-id="0af1e-224">Start by adding the following code to test invalid operations on those methods:</span></span>

:::code language="csharp" source="snippets/pattern-objects/Program.cs" ID="FinalTestCode":::

<span data-ttu-id="0af1e-225">アプリケーションをもう一度実行します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-225">Run your application again.</span></span> <span data-ttu-id="0af1e-226">新しいテストは失敗し、運河の水門が無効な状態になることを確認できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-226">You can see the new tests fail, and the canal lock gets into an invalid state.</span></span> <span data-ttu-id="0af1e-227">残りのメソッドを自分で実装してみてください。</span><span class="sxs-lookup"><span data-stu-id="0af1e-227">Try to implement the remaining methods yourself.</span></span> <span data-ttu-id="0af1e-228">低い方のゲートを設定するメソッドは、高い方のゲートを設定するメソッドに似ているはずです。</span><span class="sxs-lookup"><span data-stu-id="0af1e-228">The method to set the lower gate should be similar to the method to set the upper gate.</span></span> <span data-ttu-id="0af1e-229">水位を変更するメソッドのチェックは異なりますが、同様の構造にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-229">The method that changes the water level has different checks, but should follow a similar structure.</span></span> <span data-ttu-id="0af1e-230">水位を設定するメソッドにも同じプロセスを使用すると便利な場合があります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-230">You may find it helpful to use the same process for the method that sets the water level.</span></span> <span data-ttu-id="0af1e-231">次の 4 つのすべての入力から始めます: 両方のゲートの状態、水位の現在の状態、要求された新しい水位。</span><span class="sxs-lookup"><span data-stu-id="0af1e-231">Start with all four inputs: The state of both gates, the current state of the water level, and the requested new water level.</span></span> <span data-ttu-id="0af1e-232">switch 式の先頭は次のようになります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-232">The switch expression should start with:</span></span>

```csharp
CanalLockWaterLevel = (newLevel, CanalLockWaterLevel, LowWaterGateOpen, HighWaterGateOpen) switch
{
    // elided
};
```

<span data-ttu-id="0af1e-233">全部で 16 個の switch アームを使用します。</span><span class="sxs-lookup"><span data-stu-id="0af1e-233">You'll have 16 total switch arms to fill in.</span></span> <span data-ttu-id="0af1e-234">その後、テストと簡略化を行います。</span><span class="sxs-lookup"><span data-stu-id="0af1e-234">Then, test and simplify.</span></span>

<span data-ttu-id="0af1e-235">次のようなメソッドができましたか。</span><span class="sxs-lookup"><span data-stu-id="0af1e-235">Did you make methods something like this?</span></span>

:::code language="csharp" source="snippets/pattern-objects/CanalLock.cs" ID="FinalExercise":::

<span data-ttu-id="0af1e-236">テストは合格し、運河の水門は安全に作動するはずです。</span><span class="sxs-lookup"><span data-stu-id="0af1e-236">Your tests should pass, and the canal lock should operate safely.</span></span>

## <a name="summary"></a><span data-ttu-id="0af1e-237">まとめ</span><span class="sxs-lookup"><span data-stu-id="0af1e-237">Summary</span></span>

<span data-ttu-id="0af1e-238">このチュートリアルでは、パターン マッチングを使用して、オブジェクトの内部状態に変更を適用する前に、その状態を確認する方法について学習しました。</span><span class="sxs-lookup"><span data-stu-id="0af1e-238">In this tutorial, you learned to use pattern matching to check the internal state of an object before applying any changes to that state.</span></span> <span data-ttu-id="0af1e-239">プロパティの組み合わせを確認できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-239">You can check combinations of properties.</span></span> <span data-ttu-id="0af1e-240">それらの遷移のいずれかの表を作成したら、コードをテストして、読みやすさと保守性のために簡素化できます。</span><span class="sxs-lookup"><span data-stu-id="0af1e-240">Once you've built tables for any of those transitions, you test your code, then simplify for readability and maintainability.</span></span> <span data-ttu-id="0af1e-241">これらの初期リファクタリングにより、内部状態を検証したり、他の API 変更を管理したりするリファクタリングがさらに提案される場合があります。</span><span class="sxs-lookup"><span data-stu-id="0af1e-241">These initial refactorings may suggest further refactorings that validate internal state or manage other API changes.</span></span> <span data-ttu-id="0af1e-242">このチュートリアルでは、クラスとオブジェクトを、よりデータ指向でパターンベースのアプローチと組み合わせて、それらのクラスを実装しました。</span><span class="sxs-lookup"><span data-stu-id="0af1e-242">This tutorial combined classes and objects with a more data-oriented, pattern-based approach to implement those classes.</span></span>
